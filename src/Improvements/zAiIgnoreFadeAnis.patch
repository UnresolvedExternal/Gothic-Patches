// Fade animations should not be taken into account in the controller or AI logic:
// they are only needed for visual smoothness.
//
// Currently, only the following functions caused problems (with other patches):
// 1) oCAniCtrl_Human::IsStateAniActive - in BowMode (run to stand)
// 2) oCAniCtrl_Human::IsWalking - attack-run instead of attack

#engine [G1, G1A, G2, G2A]
	#patch [zAiIgnoreFadeAnis]
		// engine specific
		INT text_oCAniCtrl_Human_IsStateAniActive_cmp_layer = ZenDef(0x006255AC, 0x0064A2DC, 0x0065162C, 0x006ADEAC)
		INT text_oCAniCtrl_Human_IsStateAniActive_fail_cmp_layer = ZenDef(0x006255BB, 0x0064A2EB, 0x0065163B, 0x006ADEBB)
		
		INT field_oCAniCtrl_Human__s_walkl = 0x1014
		INT field_oCAniCtrl_Human__s_walkr = 0x1020
		INT field_oCAniCtrl_Human__t_walk_2_walkl = 0x100C		
		INT field_zCModelAniActive_isFadingOut = 0x1C
		INT field_zCAIPlayer_model = 0x68
		
		INT func_oCAniCtrl_Human_IsWalking = ZenDef(0x006257E0, 0x0064A540, 0x00651860, 0x006AE0E0)
		INT func_zCModel_GetActiveAni = ZenDef(0x00560D90, 0x00579220, 0x00575640, 0x0057AB60)
		// end of engine specific
		
		#assembler [text_oCAniCtrl_Human_IsStateAniActive_cmp_layer]
			orgcode
			
			push eax
			mov eax, [edx]
			mov eax, [eax+$field_zCModelAniActive_isFadingOut]
			test eax, eax
			pop eax
			
			jnz $text_oCAniCtrl_Human_IsStateAniActive_fail_cmp_layer
		#/assembler
		
		// int zCModel::IsAniNotFading(int)
		#assembler [func_zCModel_IsAniNotFading]			
			mov edx, [esp+4]
			
			push esi
			mov esi, ecx
			
			push edi
			mov edi, edx
			
			push edi
			call $func_zCModel_GetActiveAni
			
			test eax, eax
			jz return
			
			mov eax, [eax+$field_zCModelAniActive_isFadingOut]
			test eax, eax
			jnz fail
			
			mov eax, 1
			jmp return
			
		fail:
			xor eax, eax
			
		return:
			pop edi
			pop esi
			ret 4
		#/assembler
		
		// int oCAniCtrl_Human::HookIsWalking()
		#assembler [func_oCAniCtrl_Human_HookIsWalking]
			push esi
			push edi
			
			mov edi, [ecx+$field_zCAIPlayer_model]
			test edi, edi
			jz fail
			
			mov eax, [ecx+$field_oCAniCtrl_Human__t_walk_2_walkl]
			push eax
			
			mov eax, [ecx+$field_oCAniCtrl_Human__s_walkr]
			push eax
			
			mov eax, [ecx+$field_oCAniCtrl_Human__s_walkl]
			push eax
			
			mov esi, 2
			
		check:
			mov ecx, edi
			call $func_zCModel_IsAniNotFading
			
			test eax, eax
			jnz return

			test esi, esi
			jz fail
			
			dec esi
			jmp check
			
		fail:
			xor eax, eax
			
		return:
			lea esp, [esp+esi*4]
			
			pop edi
			pop esi
			ret
		#/assembler
		
		JMP(func_oCAniCtrl_Human_IsWalking, func_oCAniCtrl_Human_HookIsWalking)
	#/patch
#/engine
